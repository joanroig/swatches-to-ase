name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version_bump:
        description: "Select the version bump type"
        required: true
        default: "patch"
        type: choice
        options:
          - none
          - patch
          - minor
          - major

permissions:
  contents: write

jobs:
  version:
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.tag.outputs.version }}
      tag: ${{ steps.tag.outputs.tag }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"

      - name: Bump and commit version
        if: github.event.inputs.version_bump != 'none'
        run: |
          new_version=$(node scripts/bump-version.mjs ${{ github.event.inputs.version_bump }})
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add package.json package-lock.json
          git commit -m "Bump version to $new_version"

      - name: Push changes
        if: github.event.inputs.version_bump != 'none'
        run: git push origin HEAD:${{ github.ref_name }}

      - name: Create or move tag
        id: tag
        run: |
          version=$(node scripts/bump-version.mjs none)
          tag="v$version"
          git fetch --tags
          git tag -d "$tag" || true
          git push --delete origin "$tag" || true
          git tag "$tag"
          git push origin "$tag"
          echo "version=$version" >> "$GITHUB_OUTPUT"
          echo "tag=$tag" >> "$GITHUB_OUTPUT"

  build:
    needs: version
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: macos-latest
            platform: mac
            target: dmg
            arch_flag: "--arm64"
            artifact_suffix: "macos-arm64-installer.dmg"
          - os: macos-latest
            platform: mac
            target: zip
            arch_flag: "--arm64"
            artifact_suffix: "macos-arm64-portable.zip"
          - os: macos-15-intel
            platform: mac
            target: dmg
            arch_flag: "--x64"
            artifact_suffix: "macos-x64-installer.dmg"
          - os: macos-15-intel
            platform: mac
            target: zip
            arch_flag: "--x64"
            artifact_suffix: "macos-x64-portable.zip"
          - os: windows-latest
            platform: win
            target: nsis
            arch_flag: ""
            artifact_suffix: "windows-installer.exe"
          - os: windows-latest
            platform: win
            target: zip
            arch_flag: ""
            artifact_suffix: "windows-portable.zip"
          - os: ubuntu-latest
            platform: linux
            target: AppImage
            arch_flag: ""
            artifact_suffix: "linux-amd64-portable.AppImage"
          - os: ubuntu-latest
            platform: linux
            target: deb
            arch_flag: ""
            artifact_suffix: "linux-amd64-installer.deb"
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ needs.version.outputs.tag }}

      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version-file: ".nvmrc"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Build desktop packages
        run: |
          npm run build:desktop
          npx --no-install electron-builder --publish never --${{ matrix.platform }} ${{ matrix.target }} ${{ matrix.arch_flag }}
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_REF: refs/tags/${{ needs.version.outputs.tag }}
          GITHUB_REF_NAME: ${{ needs.version.outputs.tag }}

      - name: Upload to GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ needs.version.outputs.tag }}
          name: Release ${{ needs.version.outputs.tag }}
          files: release/palette-studio-v${{ needs.version.outputs.version }}-${{ matrix.artifact_suffix }}
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
